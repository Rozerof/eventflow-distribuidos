version: '3.8'

services:
  # 1. Base de Datos (PostgreSQL) - Sin persistencia forzada
  db:
    image: postgres:15-alpine
    container_name: postgres_spof
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: eventflow_db
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d eventflow_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ./db-init:/docker-entrypoint-initdb.d
    networks:
      - eventflow-net

  # 2. Caché (Redis)
  cache:
    image: redis:7-alpine
    container_name: redis_cache
    ports:
      - "6379:6379"
    networks:
      - eventflow-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # 3. Cola de Mensajes (RabbitMQ)
  queue:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq_queue
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 30s
      timeout: 10s
      retries: 3
    environment:
      RABBITMQ_PLUGINS: "[rabbitmq_prometheus,rabbitmq_management]."
    networks:
      - eventflow-net
    
  # 4. Aplicación Principal (Nodos de Asientos)
  app-node-1:
    build: ./app-principal
    container_name: app_node_1
    environment:
      DB_HOST: db
      REDIS_HOST: cache
      RABBITMQ_HOST: queue
      DB_NAME: eventflow_db
      DB_USER: user
      DB_PASSWORD: password
      NODE_ID: 1
    # CORRECCIÓN FINAL: Usar Exec Form para asegurar el inicio
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
    depends_on:
      db: {condition: service_healthy}
      cache: {condition: service_healthy}
      queue: {condition: service_healthy} 
    networks:
      - eventflow-net
    
  app-node-2:
    build: ./app-principal
    container_name: app_node_2
    environment:
      DB_HOST: db
      REDIS_HOST: cache
      RABBITMQ_HOST: queue
      DB_NAME: eventflow_db
      DB_USER: user
      DB_PASSWORD: password
      NODE_ID: 2
    # CORRECCIÓN FINAL: Usar Exec Form
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
    depends_on:
      db: {condition: service_healthy}
      cache: {condition: service_healthy}
      queue: {condition: service_healthy}
    networks:
      - eventflow-net
      
  app-node-3:
    build: ./app-principal
    container_name: app_node_3
    environment:
      DB_HOST: db
      REDIS_HOST: cache
      RABBITMQ_HOST: queue
      DB_NAME: eventflow_db
      DB_USER: user
      DB_PASSWORD: password
      NODE_ID: 3
    # CORRECCIÓN FINAL: Usar Exec Form
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
    depends_on:
      db: {condition: service_healthy}
      cache: {condition: service_healthy}
      queue: {condition: service_healthy}
    networks:
      - eventflow-net

  # 5. Balanceador de Carga (NGINX)
  balancer:
    build: ./nginx
    container_name: nginx_balancer
    ports:
      - "8080:80"
    depends_on:
      - app-node-1
      - app-node-2
      - app-node-3
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/index.html:/usr/share/nginx/html/index.html:ro
    networks:
      - eventflow-net
    
  # 6. Microservicio 1: Consumidor/Worker
  ms-consumer:
    build: ./microservicio-1
    container_name: ms_consumer
    restart: always
    environment:
      RABBITMQ_HOST: queue
      DB_HOST: db
      DB_NAME: eventflow_db
      DB_USER: user
      DB_PASSWORD: password
    depends_on:
      queue: {condition: service_healthy}
      db: {condition: service_healthy}
      cache: {condition: service_healthy}
    networks:
      - eventflow-net

  # 7. Microservicio 2: Análisis (API REST)
  ms-analisis:
    build: ./microservicio-2
    container_name: ms_analisis
    environment:
      DB_HOST: db
      DB_NAME: eventflow_db
      DB_USER: user
      DB_PASSWORD: password
    depends_on:
      db: {condition: service_healthy}
    networks:
      - eventflow-net

  # 8. Microservicio 3: Autenticación (API REST)
  ms-auth:
    build: ./ms-auth
    container_name: ms_auth
    restart: on-failure
    ports:
      - "8081:8001"
    environment:
      DB_HOST: db
      DB_NAME: eventflow_db
      DB_USER: user
      DB_PASSWORD: password
    # CORRECCIÓN FINAL: Usar Exec Form
    command: ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8001"]
    depends_on:
      db: {condition: service_healthy}
      mail-sender: {condition: service_healthy}
    networks:
      - eventflow-net

  # 9. Monitoreo (Prometheus)
  prometheus:
    image: prom/prometheus:v2.40.1
    container_name: prometheus_server
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    depends_on:
      - db
      - queue
      - balancer
    networks:
      - eventflow-net
      
  # 10. Visualización (Grafana)
  grafana:
    image: grafana/grafana:9.3.2
    container_name: grafana_dashboard
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    networks:
      - eventflow-net

  mail-sender:
    build: ./mailsender
    container_name: mail_sender
    environment:
      RABBITMQ_HOST: queue
      MAIL_USER: lauris142003@gmail.com
      MAIL_PASS: kxuu uzly fwzy dmwr
      MAIL_SMTP: smtp.gmail.com
      MAIL_PORT: 587
    depends_on:
      queue:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "echo ok"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - eventflow-net

networks:
  eventflow-net:
    driver: bridge